import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import java.net.URI;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

@Service
public class WeatherService {

    @Value("${weather.api.key}")
    private String serviceKey;

    @Value("${weather.api.url}")
    private String apiUrl;

    public void fetchAndSaveWeather() {
        try {
            RestTemplate restTemplate = new RestTemplate();

            // 1. 날짜 및 시간 설정 (현재 시점 기준 1시간 전 데이터 - 실황 API 특성상 안전함)
            String baseDate = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
            String baseTime = LocalTime.now().minusHours(1).format(DateTimeFormatter.ofPattern("HH00"));

            // 2. URI 구성 (인코딩 방지를 위해 build(true) 사용)
            URI uri = UriComponentsBuilder.fromHttpUrl(apiUrl)
                    .queryParam("serviceKey", serviceKey)
                    .queryParam("pageNo", "1")
                    .queryParam("numOfRows", "1000")
                    .queryParam("dataType", "JSON")
                    .queryParam("base_date", baseDate)
                    .queryParam("base_time", baseTime)
                    .queryParam("nx", "60") // 수원/서울 인근 좌표
                    .queryParam("ny", "121")
                    .build(true)
                    .toUri();

            // 3. 호출 및 저장
            String response = restTemplate.getForObject(uri, String.class);
            Files.writeString(Paths.get("weather.json"), response);

            System.out.println("성공! weather.json 파일이 생성되었습니다.");

        } catch (Exception e) {
            System.err.println("에러 발생: " + e.getMessage());
            e.printStackTrace();
        }
    }
}